<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>BlazorGalaga</title>
    <base href="/" />
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link href="css/app.css" rel="stylesheet" />
    <script src="_content/Blazor.Extensions.Canvas/blazor.extensions.canvas.js"></script>
</head>

<body>
    <app>Loading...</app>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">🗙</a>
    </div>
    <script src="_framework/blazor.webassembly.js"></script>
</body>

</html>

<script>

    document.addEventListener("keydown", function (e) {
        DotNet.invokeMethodAsync('BlazorGalaga', 'OnKeyDown', e.code);
    });
    document.addEventListener("keyup", function (e) {
        DotNet.invokeMethodAsync('BlazorGalaga', 'OnKeyUp', e.code);
    });

    window.addEventListener("resize", resizeCanvas);

    window.initFromBlazor = (instance) => {

        resizeCanvas();

        window.instance = instance;

        window.requestAnimationFrame(gameLoop);

    };

    window.logDiagnosticInfo = function(diagnosticinfo) {
        document.getElementById("divDiagnostics").innerHTML = diagnosticinfo;
    }

    //let framesPerSecond = 60;

    function gameLoop() {
        window.requestAnimationFrame(gameLoop);
        window.instance.invokeMethodAsync('GameLoop');
        //setTimeout(function () {

        //    window.requestAnimationFrame(gameLoop);

        //    window.instance.invokeMethodAsync('GameLoop');

        //}, 1000 / framesPerSecond);
    }

    function resizeCanvas(){

        var canvas = document.querySelector('canvas');
        var ctx = canvas.getContext('2d');

        //very important to make the pixels look crisp
        ctx.imageSmoothingEnabled = false;

        var game = {
            canvas: document.getElementById("theCanvas"),
            width: 672,
            height: 944
        };

        var newGameWidth, newGameHeight;

        // Get the dimensions of the viewport
        var viewport = {
            width: window.innerWidth,
            height: window.innerHeight
        };

        // Determine game size
        const ratio = game.height / game.width;
        const viewportRatio = viewport.height / viewport.width;

        if (ratio > viewportRatio) {
            newGameHeight = viewport.height;
            newGameWidth = newGameHeight * game.width / game.height;
        } else {
            newGameWidth = viewport.width;
            newGameHeight = newGameWidth * game.height / game.width;
        }

        game.canvas.style.width = newGameWidth + "px";
        game.canvas.style.height = newGameHeight + "px";

        var paddingX = (viewport.width - newGameWidth) / 2;
        var paddingY = (viewport.height - newGameHeight) / 2;
        var margin = paddingY + "px " + paddingX + "px";

        // Set the new margin of the game so it will be centered
        game.canvas.style.margin = margin;

    };


</script>